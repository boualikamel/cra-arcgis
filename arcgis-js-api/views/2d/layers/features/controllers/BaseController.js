// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/Error","../../../../../core/HandleOwner","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/data/attributeSupport","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/support/FieldsIndex","../../../../../renderers/support/jsonUtils","../../../../../tasks/support/QuantizationParameters","../../../../../tasks/support/Query","../../../engine","../support/AttributeStore","../support/ClusterStore","../support/pixelBuffering"],function(e,t,r,i,o,n,s,u,a,l,p,c,d,f,y,h,g,b,m,v,S,O,w,I){function F(e){var t=e&&e.getSymbols();return"backgroundFillSymbol"in e&&null!=e.backgroundFillSymbol&&"outline"in e.backgroundFillSymbol&&null!=e.backgroundFillSymbol.outline||t.some(function(e){return"outline"in e&&null!=e.outline})}function P(e,t,r){function i(e){if(!e)return!1;var t=e.type;return"simple-marker"===t||"picture-marker"===t||"text"===t||"web-style"===t||"cim"===t}if("esriGeometryPolygon"===t&&e.labelingInfo)return!0;if("esriGeometryPolygon"!==t)return!1;switch(r.type){case"simple":return i(r.symbol);case"unique-value":return i(r.defaultSymbol)||r.uniqueValueInfos.some(function(e){return i(e.symbol)});case"class-breaks":return i(r.defaultSymbol)||r.classBreakInfos.some(function(e){return i(e.symbol)});case"dot-density":return!1;default:return!0}}function x(e,t){switch(e){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryMultipoint":return!0;case"esriGeometryPolygon":return F(t)}}Object.defineProperty(t,"__esModule",{value:!0});var R=p.getLogger("esri.views.2d.layers.features.controllers.BaseController"),_=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._availableFields=[],t._pixelBuffer=0,t.config=null,t.filters=new Array(S.definitions.MAX_FILTERS),t.processor=null,t.remoteClient=null,t.service=null,t.tileStore=null,t}return n(t,e),t.prototype.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._initAttributeStore()},t.prototype.startup=function(){return o(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return this._initAttributeStore(),[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 1:return e.sent(),[4,d.all([this.attributeStore.updateFilters(this),this.updatePixelBuffer()])];case 2:return e.sent(),[2]}})})},t.prototype.destroy=function(){this.attributeStore&&this.attributeStore.destroy()},Object.defineProperty(t.prototype,"arcadeInfo",{get:function(){return{geometryType:this.service.geometryType,fields:this.service.fields,spatialReference:this.spatialReference}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"featureReduction",{get:function(){return this.config.featureReduction},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fieldsIndex",{get:function(){return new g(this.service.fields)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometryInfo",{get:function(){return{geometryType:this.service.geometryType,hasZ:!1,hasM:!1}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"returnCentroid",{get:function(){return this._get("returnCentroid")||P(this.config,this.service.geometryType,this.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"returnOutline",{get:function(){return x(this.service.geometryType,this.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"queryInfo",{get:function(){return{returnCentroid:this.returnCentroid,returnGeometry:!0,outFields:this.availableFields,definitionExpression:this.config.definitionExpression,gdbVersion:this.config.gdbVersion,historicMoment:this.config.historicMoment}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{get:function(){return this.config?b.fromJSON(this.config.renderer):(R.error("mapview-controller","Unable to create renderer for undefined configuration"),null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"availableFields",{get:function(){var e=this,t=this.config.availableFields.filter(function(t){return-1===e._availableFields.indexOf(t)});return this._availableFields=this._availableFields.concat(t),this._availableFields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this.tileStore.tileScheme.spatialReference},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewParams",{get:function(){return{viewingMode:"",scale:this.viewState&&this.viewState.scale||1}},enumerable:!0,configurable:!0}),t.prototype.getObjectId=function(e){return this.attributeStore.getFeatureId(e)},t.prototype.getAggregate=function(e){return null},t.prototype.getAggregateValueRanges=function(){return{}},t.prototype.getLocalId=function(e){return this.attributeStore.getLocalId(e)},t.prototype.mapValidLocalIds=function(e){var t=this;return e.map(function(e){return t.attributeStore.getLocalId(e)}).filter(function(e){return null!=e})},t.prototype.setViewState=function(e){this._set("viewState",e)},t.prototype.updatePixelBuffer=function(){return o(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:return[4,I.computePxBuffer(this.renderer,this.service.geometryType)];case 1:return e=t.sent(),this._pixelBuffer=Math.max(this._pixelBuffer,e),[2]}})})},t.prototype.setHighlight=function(e){return o(this,void 0,void 0,function(){return i(this,function(t){return[2,this.attributeStore.setHighlight(e)]})})},t.prototype.validateConfig=function(e){for(var t=0,r=e.filters;t<r.length;t++){var i=r[t];if(c.isSome(i)&&i.where)try{y.validateWhere(this.fieldsIndex,i.where)}catch(e){throw new u("mapview-bad-filter",e.message,{filter:i,missingFields:e.details})}}},t.prototype.onFeatureAdd=function(e){e.localId=this.attributeStore.createLocalId(e.objectId),this.attributeStore.setAttributeData(e.localId,e,this.geometryInfo,this.viewParams)},t.prototype.onFeatureRemove=function(e){!e.localId&&l("esri-2d-debug")&&console.debug("Feature must have localId"),this.attributeStore.freeLocalId(e.objectId)},t.prototype.enableEvent=function(e){},t.prototype._initAttributeStore=function(){var e=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new O.default({type:"remote",initialize:function(t,r){return e.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:r})},update:function(t,r){return e.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:r})},render:function(){return e.remoteClient.invoke("tileRenderer.featuresView.requestRender")}})},t.prototype._createQueryEngine=function(e){return new h.default({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:e,timeInfo:this.service.timeInfo})},t.prototype._createTempQueryEngine=function(e){return void 0===e&&(e=this._createFeatureStore()),this._createQueryEngine(e)},t.prototype._createFeatureStore=function(){var e={geometryType:this.service.geometryType,hasM:!1,hasZ:!1};return new w.ClusterStore(e,this.spatialReference,this.attributeStore,this.featureReduction)},t.prototype._createDefaultQuery=function(e){var t=new v,r=e.outFields,i=this.config,o=i.gdbVersion,n=i.historicMoment,s=i.definitionExpression;return r=r.length/this.service.fields.length>=.75?["*"]:r,t.gdbVersion=o,t.historicMoment=null!=n?new Date(n):null,t.num=e.num,t.outFields=r,t.outSpatialReference=this.spatialReference,t.returnGeometry=e.returnGeometry,t.returnCentroid=e.returnCentroid,t.start=e.resultOffset,t.where=s||"1=1",t},t.prototype._createQuery=function(e,t,r,i,o,n){var s=this.service.geometryType,u=this._createDefaultQuery(i);return u.maxRecordCountFactor=o,u.returnExceededLimitFeatures=n,u.resultType="tile",u.geometry=e,this.service.capabilities.query.supportsQuantization?(u.quantizationParameters=new m.default({mode:"view",originPosition:"upper-left",tolerance:r,extent:t}),"esriGeometryPolyline"===s&&(u.maxAllowableOffset=r)):"esriGeometryPolyline"!==s&&"esriGeometryPolygon"!==s||(u.maxAllowableOffset=r),u},t.prototype.hasGeometryFilter=function(){return this.filters.some(function(e){return c.isSome(e)&&!!e.geometry})},r([f.property({readOnly:!0,dependsOn:["config","service","spatialReference"]})],t.prototype,"arcadeInfo",null),r([f.property()],t.prototype,"config",void 0),r([f.property({readOnly:!0,dependsOn:["config"]})],t.prototype,"featureReduction",null),r([f.property({readOnly:!0,dependsOn:["service"]})],t.prototype,"fieldsIndex",null),r([f.property()],t.prototype,"filters",void 0),r([f.property({readOnly:!0,dependsOn:["service"]})],t.prototype,"geometryInfo",null),r([f.property({readOnly:!0,dependsOn:["config"]})],t.prototype,"returnCentroid",null),r([f.property({readOnly:!0,dependsOn:["service","config"]})],t.prototype,"returnOutline",null),r([f.property({readOnly:!0,dependsOn:["config","availableFields"]})],t.prototype,"queryInfo",null),r([f.property({dependsOn:["config"],readOnly:!0})],t.prototype,"renderer",null),r([f.property()],t.prototype,"processor",void 0),r([f.property({readOnly:!0,dependsOn:["config"]})],t.prototype,"availableFields",null),r([f.property({constructOnly:!0})],t.prototype,"remoteClient",void 0),r([f.property({constructOnly:!0})],t.prototype,"service",void 0),r([f.property({dependsOn:["tileStore"]})],t.prototype,"spatialReference",null),r([f.property({constructOnly:!0})],t.prototype,"tileInfo",void 0),r([f.property({constructOnly:!0})],t.prototype,"tileStore",void 0),r([f.property({readOnly:!0})],t.prototype,"viewState",void 0),r([f.property({readOnly:!0,dependsOn:["viewState"]})],t.prototype,"viewParams",null),t=r([f.subclass("esri.views.2d.layers.features.controllers.BaseController")],t)}(f.declared(a.HandleOwner));t.default=_});