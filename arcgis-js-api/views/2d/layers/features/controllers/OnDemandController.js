// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/ArrayPool","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/now","../../../../../core/promiseUtils","../../../../../core/watchUtils","../../../../../core/workers","../../../../../core/accessorSupport/decorators","../../../../../geometry/Extent","../../../../../geometry/support/jsonUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../tasks/operations/query","../../../engine","./BaseController","./EditsQueue","../support/DataTile","../support/DataTileFeaturesIndex","../support/Tile","../support/TileUpdateQueue","../../../tiling/TileQueue"],function(e,t,r,i,n,s,u,o,a,c,l,d,h,f,p,y,g,v,_,b,m,I,S,T,x,F,Q,w){Object.defineProperty(t,"__esModule",{value:!0});var E=l.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),C=c("esri-featurelayer-webgl"),q=c("esri-mobile"),j={maxDrillLevel:C&&"object"==typeof C&&null!=C.maxDrillLevel?C.maxDrillLevel:q?1:4,maxRecordCountFactor:C&&"object"==typeof C&&null!=C.maxRecordCountFactor?C.maxRecordCountFactor:q?1:3,enablePBFQuery:!C||"object"!=typeof C||null==C.enablePBFQuery||C.enablePBFQuery},O=new Set,A=[],P=function(){function e(e,t){this.objectIdField=t,this.client=p.openWithPorts(e)}return e.prototype.destroy=function(){this.client.close(),this.client=null},e.prototype.executeQuery=function(e,t){return u(this,void 0,void 0,function(){var r;return s(this,function(i){switch(i.label){case 0:return[4,this.client.invoke("queryFeatures",e.toJSON(),t)];case 1:return r=i.sent(),[2,_.convertFromFeatureSet(r,this.objectIdField)]}})})},e}(),D=function(){function e(e){this.source=e}return e.prototype.destroy=function(){},e.prototype.executeQuery=function(e,t){return u(this,void 0,void 0,function(){var r;return s(this,function(i){switch(i.label){case 0:return[4,b.executeQueryPBF(this.source,e,{type:"optimized"},t)];case 1:return r=i.sent().data,[2,r]}})})},e}(),R=function(){function e(e,t){this.source=e,this.objectIdField=t}return e.prototype.destroy=function(){},e.prototype.executeQuery=function(e,t){return u(this,void 0,void 0,function(){var r;return s(this,function(i){switch(i.label){case 0:return[4,b.executeQuery(this.source,e,t)];case 1:return r=i.sent().data,[2,_.convertFromFeatureSet(r,this.objectIdField)]}})})},e}(),B=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._dataTileIndex=new x.default,t._editsQueue=new S.EditsQueue({processEdits:t._processEdits.bind(t)}),t._featuresInFlight=new Map,t}return r(t,e),t.prototype.initialize=function(){var e=this,t=this._createFeatureStore();t.onFeatureAdd=this.onFeatureAdd.bind(this),t.onFeatureRemove=this.onFeatureRemove.bind(this),this._set("featureStore",t),this._dataTileIndex.featureStore=this.featureStore,this._dataTileIndex.forEach(function(e){return e.done=!1}),this._fetchQueue=new w({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t,e.queryInfo,r)}}),this._patchQueue=new w({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t.dataTile,t.queryInfo,r)}}),this._updateQueue=new Q.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r,i){return e._updateTile(t,r,i)}});var r=this.service,i=r.capabilities,n=r.source,s=r.objectIdField;Array.isArray(n)?this.sourceAdapter=new P(n,s):j.enablePBFQuery&&i.query.supportsFormatPBF?this.sourceAdapter=new D(n):this.sourceAdapter=new R(n,s),this.handles.add([this.watch("updating",function(t){return!t&&e.onIdle()})]),this.featureStore.events.on("valueRangesChanged",function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}})})},t.prototype.destroy=function(){this._fetchQueue.clear(),this._patchQueue.clear(),this._updateQueue.clear(),this._editsQueue.destroy(),this.queryEngine.destroy(),this.sourceAdapter.destroy()},Object.defineProperty(t.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.featureStore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.viewState||this._fetchQueue.updating||this._patchQueue.updating||this._updateQueue.updating||this._editsQueue.updating},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return u(this,void 0,void 0,function(){var r,i,n,u,o,a,c=this;return s(this,function(s){switch(s.label){case 0:return this.validateConfig(e),r=JSON.stringify(this.config.filters),i=this.renderer.getAttributeHash(),n=e.availableFields.filter(function(e){return-1===c.availableFields.indexOf(e)}),u=this.config.definitionExpression,this._set("config",e),u!==this.config.definitionExpression&&this._set("queryEngine",this._createQueryEngine(this.featureStore)),[4,this.updatePixelBuffer()];case 1:return s.sent(),o=r!==JSON.stringify(e.filters),a=i!==this.renderer.getAttributeHash(),t?a?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,3]:[3,6];case 2:s.sent(),s.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return s.sent(),[4,this.featureStore.update(o,e)];case 5:return s.sent(),this.refresh(),[2];case 6:return n.length?[4,this._handleAttributeChange(n)]:[3,8];case 7:s.sent(),s.label=8;case 8:return"heatmap"===this.renderer.type?[2]:a?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,10];case 9:s.sent(),this.featureStore.forEach(function(e){return c.attributeStore.setAttributeData(e.localId,e,c.geometryInfo,c.viewParams)}),s.label=10;case 10:return[4,this.attributeStore.updateFilters(this)];case 11:return s.sent(),[4,this.featureStore.update(o,e)];case 12:return s.sent(),[4,this.attributeStore.sendUpdates()];case 13:return s.sent(),[2]}})})},t.prototype.invalidate=function(){return u(this,void 0,void 0,function(){var e,t,r;return s(this,function(i){for(e=0,t=this.tileStore.tiles;e<t.length;e++)r=t[e],this._updateQueue.push(r.id,Date.now());return[2]})})},t.prototype.onIdle=function(){this.featureStore.sweepClusters()},t.prototype.onEdits=function(e){var t=this;return this._fetchQueue.pause(),this._fetchQueue.reset(),this._editsQueue.push(e).then(function(){t._editsQueue.updating||t._fetchQueue.resume()})},t.prototype.queryFeatures=function(e){return this.queryEngine.executeQuery(e)},t.prototype.queryFeatureCount=function(e){return this.queryEngine.executeQueryForCount(e)},t.prototype.queryObjectIds=function(e){return this.queryEngine.executeQueryForIds(e)},t.prototype.queryExtent=function(e){return this.queryEngine.executeQueryForExtent(e)},t.prototype.queryStatistics=function(e){return u(this,void 0,void 0,function(){var e,t,r,i=this;return s(this,function(o){switch(o.label){case 0:return e=0,t=0,r=0,[4,h.all(this.tileStore.tiles.map(function(n){return u(i,void 0,void 0,function(){var i,u,o,a,c,l,h,f,p,y,g;return s(this,function(s){switch(s.label){case 0:return i=this.queryInfo,u=i.returnCentroid,o=i.returnGeometry,a=this._pixelBuffer,c={pixelBuffer:a,returnGeometry:o,returnCentroid:u,returnOutline:this.returnOutline},l=d(),[4,this.featureStore.executeTileQuery(n,this.spatialReference,c)];case 1:for(h=s.sent().features,f=d(),r+=f-l,e+=h.length,p=0,y=h;p<y.length;p++)g=y[p],g.geometry&&(v.isPolygon(g.geometry)?t+=g.geometry.rings.reduce(function(e,t){return e+t.length},0):v.isPolyline(g.geometry)&&(t+=g.geometry.paths.reduce(function(e,t){return e+t.length},0)));return[2]}})})}))];case 1:return o.sent(),[2,n({},this.featureStore.storeStatistics,{displayedFeatureCount:e,displayedVertexCount:t,displayPreProcessTime:r})]}})})},t.prototype.refresh=function(){return u(this,void 0,void 0,function(){var e=this;return s(this,function(t){switch(t.label){case 0:return this._queryInfoHash=Math.random().toString(),this._dataTileIndex.clear(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.clear(),this._updateQueue.clear(),this.featureStore.startMarkingUsedFeatures(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),[4,f.whenFalseOnce(this._fetchQueue,"updating")];case 1:return t.sent(),this.featureStore.sweep(),this.featureStore.forEach(function(t){return e.attributeStore.setAttributeData(t.localId,t,e.geometryInfo,e.viewParams)}),this.attributeStore.sendUpdates(),this._updateQueue.resume(),[2]}})})},t.prototype.setViewState=function(e){var t=this,r=this.viewState&&this.viewState.scale;this.inherited(arguments),this._fetchQueue.state=e,this._updateQueue.state=e,r!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach(function(e){return t.attributeStore.setAttributeData(e.localId,e,t.geometryInfo,t.viewParams)}),this.attributeStore.sendUpdates())},t.prototype.getAggregate=function(e){return this.featureStore.getAggregate(e)},t.prototype.getAggregateValueRanges=function(){return this.featureStore.getAggregateValueRanges()},t.prototype.onTileUpdate=function(e){this._manageTiles(e.added,e.removed),this.featureStore.onTileUpdate(e)},t.prototype.onFeatureAdd=function(e){if(this._featuresInFlight.has(e.objectId)){var t=this._featuresInFlight.get(e.objectId).attributes;e.attributes=n({},t,e.attributes),this._featuresInFlight.delete(e.objectId)}e.localId=this.attributeStore.createLocalId(e.objectId),this.attributeStore.setAttributeData(e.localId,e,this.geometryInfo,this.viewParams)},t.prototype._handleAttributeChange=function(e){return u(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return[4,this._fetchChangedFields(e)];case 1:return t.sent(),[2]}})})},t.prototype._fetchChangedTileFields=function(e,t){return u(this,void 0,void 0,function(){var r,i;return s(this,function(n){return(r=this._dataTileIndex.get(e.id))?(i=!1,i?[2,this._fetchChangedTileFieldsPaged(r,t)]:[2,this._fetchChangedTileFieldsDrill(r,t)]):[2]})})},t.prototype._fetchChangedTileFieldsDrill=function(e,t,r){return void 0===r&&(r=0),u(this,void 0,void 0,function(){var i,u,o,a,c,l,d,f,p,y,g=this;return s(this,function(s){switch(s.label){case 0:return i=n({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField])}),e.returnExceeded=e.returnExceeded||r>=j.maxDrillLevel,u=e.key,o={key:u,dataTile:e,queryInfo:i},[4,this._patchQueue.push(o)];case 1:return a=s.sent(),a.exceededTransferLimit&&r<j.maxDrillLevel?(c=e.tile.createChildTiles(),l=c.map(function(t){var r=new T.default;return r.tile=t,r.displayTile=e.displayTile,r}),[4,h.all(l.map(function(e){return g._fetchChangedTileFieldsDrill(e,t,r+1)}))]):[3,3];case 2:return s.sent(),[2];case 3:for(d=0,f=a.features;d<f.length;d++)p=f[d],this.featureStore.has(p.objectId)?(y=this.featureStore.getFeature(p.objectId),y.attributes=n({},y.attributes,p.attributes)):this._featuresInFlight.set(p.objectId,p);return[2]}})})},t.prototype._fetchChangedTileFieldsPaged=function(e,t,r){return void 0===r&&(r=0),u(this,void 0,void 0,function(){var i,u,o,a,c,l,d,h,f,p,y;return s(this,function(s){switch(s.label){case 0:return i=this.service.capabilities.query.supportsMaxRecordCountFactor,u=this.service.tileMaxRecordCount,o=u*(i?1:j.maxRecordCountFactor),a=n({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField]),resultOffset:r*o,num:o}),e.returnExceeded=!0,c=e.key,l={key:c,dataTile:e,queryInfo:a},[4,this._patchQueue.push(l)];case 1:for(d=s.sent(),h=0,f=d.features;h<f.length;h++)p=f[h],this.featureStore.has(p.objectId)?(y=this.featureStore.getFeature(p.objectId),y.attributes=n({},y.attributes,p.attributes)):this._featuresInFlight.set(p.objectId,p);return d.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(e,t,r+1)]:[2]}})})},t.prototype._fetchChangedFields=function(e){return u(this,void 0,void 0,function(){var t,r,i=this;return s(this,function(n){switch(n.label){case 0:return t=this.tileStore.tiles,r=t.map(function(t){return i._fetchChangedTileFields(t,e)}),[4,h.all(r)];case 1:return n.sent(),[2]}})})},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,n=this._updateQueue,s="esriGeometryPoint"===this.service.geometryType,u=this,o=0,a=e;o<a.length;o++){var c=a[o];!function(e){var t=r.get(e.id);t?(t.displayTile=e,s?r.forEach(function(r){F.isChildOf(r,t)&&(r.displayTile=e)}):t.done=!1):(t=new T.default,t.tile=e.clone(),t.displayTile=e,r.add(t)),u._processDataTile(t)}(c)}if(t)for(var l=0,d=t;l<d.length;l++){var c=d[l];O.add(c),n.abort(c.id)}r.forEach(function(e){O.has(e.displayTile)&&A.push(e)});for(var h=0,f=A;h<f.length;h++){var p=f[h];i.abort(p.id),r.delete(p)}A.length=0,O.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.displayTile,i=e.key,n=this._dataTileIndex,s=this._fetchQueue,u=i.id,o=this._queryInfoHash,c=i.level-r.key.level>=j.maxDrillLevel;if(n.add(e),e.done||s.has(u)){if(e.queryInfoHash!==o||e.returnExceeded!==c)if(e.done)e.done=!1;else{if(!s.isOngoing(u))return e.queryInfoHash=o,void(e.returnExceeded=c);s.abort(u)}}else e.queryInfoHash=o,e.returnExceeded=c;if(e.done)return void this._invalidateTile(e.displayTile);s.has(u)||s.push(e).then(function(r){return t._handleResponse(e,r)}).catch(function(r){h.isAbortError(r)||E.error(new a("featurelayer-controller:tile-error","Encountered an error when handling tile response",r)),e.done=!0,t._invalidateTile(e.displayTile)})},t.prototype._handleResponse=function(e,t){if(e.done=!0,_.hydrateOptimizedFeatureSet(t),t.exceededTransferLimit)if(e.returnExceeded)this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);else{for(var r=e.tile.createChildTiles(),i=0,n=r;i<n.length;i++){var s=n[i],u=new T.default;u.tile=s,u.displayTile=e.displayTile,this._processDataTile(u)}o.release(r)}else this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);this._invalidateTile(e.tile)},t.prototype._deleteChildrenDataTiles=function(e){this._dataTileIndex.forEach(function(t){F.isChildOf(t,e)&&A.push(t)});for(var t=0,r=A;t<r.length;t++){var i=r[t];this._fetchQueue.abort(i.id),this._dataTileIndex.delete(i)}A.length=0},t.prototype._fetchTile=function(e,t,r){return u(this,void 0,void 0,function(){var i,n,u,o,a,c,l,d,h,f,p;return s(this,function(s){switch(s.label){case 0:return i=new g({xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference}),n=this.service.geometryType,u="esriGeometryPoint"===n?e.tile:e.displayTile,o=u.extent,a=u.resolution,c=e.returnExceeded,l=this._createQuery(i,o,a,t,j.maxRecordCountFactor,c),[4,this.sourceAdapter.executeQuery(l,r)];case 1:if(d=s.sent(),"esriGeometryPolygon"===n)for(h=0,f=d.features;h<f.length;h++)p=f[h],p.geometry=_.removeCollinearVectices(p.geometry,p.geometry,n,!1,!1);return[2,d]}})})},t.prototype._invalidateTile=function(e){for(var t=this._pixelBuffer,r=this._updateQueue,i=this.tileStore.intersections(e,t),n=0,s=i;n<s.length;n++){var u=s[n].tile;r.push(u.id,u.updateTimestamp)}},t.prototype._updateTile=function(e,t,r){return u(this,void 0,void 0,function(){var i,n,u,o,a,c,l,d,f,p,y,g,v=this;return s(this,function(s){switch(s.label){case 0:return i=this.tileStore.get(e),n=this.queryInfo,u=n.returnCentroid,o=n.returnGeometry,a=this._pixelBuffer,c={pixelBuffer:a,returnGeometry:o,returnCentroid:u,returnOutline:this.returnOutline},[4,this.featureStore.executeTileQuery(i,this.spatialReference,c)];case 1:return l=s.sent(),d=l.features,f=l.objectIds,[4,this.attributeStore.sendUpdates()];case 2:return s.sent(),p={geometryType:this.service.geometryType,features:d,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:i.transform},y=[],g=!0,this._dataTileIndex.forEach(function(e){i.id!==e.id&&F.isChildOf(e,i)&&g&&!e.done&&(g=!1)}),g&&i&&i.objectIds.forEach(function(e){if(!f.has(e)){var t=v.attributeStore.getLocalId(e);y.push(t)}}),f.forEach(function(e){i.objectIds.add(e)}),i.updateTimestamp=t,[2,this.processor.onTileData(i,{clear:!0,addOrUpdate:p.features,remove:y,transformParams:m.Utils.getTransformParams(p)},r).catch(function(e){h.isAbortError(e)||E.error("update-tile",e)})]}})})},t.prototype._processEdits=function(e,t,r){return u(this,void 0,void 0,function(){var i,o,a,c,l,d=this;return s(this,function(f){switch(f.label){case 0:return i=this._createTempQueryEngine(),o=this._createObjectIdsQuery(e),e.length?[4,this.sourceAdapter.executeQuery(o)]:[3,2];case 1:a=f.sent(),_.hydrateOptimizedFeatureSet(a),this._dataTileIndex.addOrUpdateFeatures(a.features),i.featureStore.addMany(a.features),f.label=2;case 2:return c=t.concat(e).map(function(e){return d.attributeStore.getLocalId(e)}),this._dataTileIndex.deleteFeaturesById(t),this.attributeStore.sendUpdates(),l=n({},this.queryInfo,{pixelBuffer:this._pixelBuffer,returnOutline:this.returnOutline}),this.tileStore.tiles.map(function(e){return u(d,void 0,void 0,function(){var t,n;return s(this,function(s){switch(s.label){case 0:return[4,i.featureStore.executeTileQuery(e,this.spatialReference,l)];case 1:return t=s.sent().features,n={transform:e.transform,hasZ:!1,hasM:!1},[2,this.processor.onTileData(e,{addOrUpdate:t,remove:c,transformParams:n},r).catch(function(e){h.isAbortError(e)||E.error("update-tile",e)})]}})})}),i.destroy(),[2]}})})},t.prototype._createObjectIdsQuery=function(e){var t=this._createDefaultQuery(this.queryInfo);return t.objectIds=e,t},i([y.property()],t.prototype,"_fetchQueue",void 0),i([y.property()],t.prototype,"_patchQueue",void 0),i([y.property()],t.prototype,"_updateQueue",void 0),i([y.property()],t.prototype,"_editsQueue",void 0),i([y.property({readOnly:!0})],t.prototype,"featureStore",void 0),i([y.property()],t.prototype,"sourceAdapter",void 0),i([y.property({readOnly:!0,dependsOn:["featureStore","service"]})],t.prototype,"queryEngine",null),i([y.property({dependsOn:["viewState","_fetchQueue.updating","_updateQueue.updating","_patchQueue.updating","_editsQueue.updating"]})],t.prototype,"updating",null),t=i([y.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],t)}(y.declared(I.default));t.default=B});