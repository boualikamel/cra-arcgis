// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/MapPool","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/SpatialReference","../../../../../layers/support/LabelClass","../../../../../layers/support/labelFormatUtils","../../../../../renderers/support/jsonUtils","../../../engine","../../../arcade/utils","../../../engine/webgl/util/symbolUtils","../../../engine/webgl/util/vvFlagUtils","./BaseProcessor"],function(e,t,r,n,i,o,s,a,l,c,u,p,f,h,d,y,g,m,v,b,_,S,I){function M(e,t,r){r.has(e)||r.set(e,new Set);for(var n=r.get(e),i=t.length,o=0;o<i;o++){var s=t.charCodeAt(o);n.add(s)}}Object.defineProperty(t,"__esModule",{value:!0});var w=c.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor"),O=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._symbolToMosaicItemMap=new Map,t._visualSetPromises=new Map,t.type="symbol",t}return r(t,e),t.prototype.initialize=function(){this._factory=this._createFactory()},t.prototype.destroy=function(){this._visualSetPromises.clear(),this._symbolToMosaicItemMap.clear(),this.notifyChange("updating")},Object.defineProperty(t.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelingInfo",{get:function(){return!this.config||p.isNone(this.config.labelingInfo)?null:this.config.labelingInfo.map(function(e){return y.fromJSON(e)})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelClassInfos",{get:function(){var e=this;return this.labelingInfo?f.all(this.labelingInfo.map(function(t,r){return s(e,void 0,void 0,function(){var e;return o(this,function(n){switch(n.label){case 0:return e={index:r,minScale:t.minScale,maxScale:t.maxScale},[4,g.createLabelFunction(t,this.service.fields,this.spatialReference)];case 1:return[2,(e.builder=n.sent(),e.symbol=t.symbol,e)]}})})})):f.resolve()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hydrate",{get:function(){return b.createHydrateFactory(this.service.geometryType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{get:function(){return this.config?m.fromJSON(this.config.renderer):(l("esri-2d-debug")&&console.debug("Unable to create renderer for undefined configuration"),null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._visualSetPromises.size>0},enumerable:!0,configurable:!0}),t.prototype.update=function(e){return s(this,void 0,void 0,function(){var t;return o(this,function(r){return t=this._getMeshHash(),this._set("config",e),t!==this._getMeshHash()?this._factory=this._createFactory():this._factory.update(this.labelingInfo,this.renderer,this.tileStore.tileScheme.tileInfo),[2]})})},t.prototype.onTileData=function(e,t,r){var n,i=this,o=t.addOrUpdate,s=t.remove,a=t.clear;n=o&&o.length?this._processFeatures(e,o,t.transformParams):f.resolve();var l=r.signal,c=n.then(function(t){var r=t&&t.message||null,n=t&&t.transferList||null;return i.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{addOrUpdate:r,remove:s,clear:a}},{transferList:n,signal:l})}).catch(function(t){return i._handleError(e,t,r)});return this._visualSetPromises.set(e,c),f.always(c,function(){return i._cleanPromise(e)}),this.notifyChange("updating"),c},t.prototype.onTileError=function(e,t,r){var n=this,i=r.signal,o=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t},{signal:i});return this._visualSetPromises.set(e,o),f.always(o,function(){return n._cleanPromise(e)}),this.notifyChange("updating"),o},t.prototype._getMeshHash=function(){var e=S.getVVFlags("visualVariables"in this.renderer&&this.renderer.visualVariables||[]);return this.renderer.getMeshHash()+"."+e},t.prototype._createFactory=function(){var e=this,t=this.service,r=t.geometryType,n=t.objectIdField,i=t.fields,o=function(t,r){return e.remoteClient.invoke("tileRenderer.getMaterialItems",t,r)},s=d.fromJSON(this.spatialReference),a={geometryType:r,fields:i,spatialReference:s},l=new v.WGLTemplateStore(o,!1),c=this.tileStore.tileScheme.tileInfo;return this._matcher=v.createMatcher(this.renderer,l,a),new v.WGLMeshFactory(r,n,this.renderer,l,this.labelingInfo,c)},t.prototype._cleanPromise=function(e){this._visualSetPromises.delete(e),this.notifyChange("updating")},t.prototype._processFeatures=function(e,t,r){var n=this;if(!t||!t.length)return f.resolve(null);var i=this._factory,o={viewingMode:"",scale:e.scale};return this._matcher.then(function(e){return i.analyze(t,!1,e,r,o)}).then(function(t){return n._getLabelMosaicItems(e,t,r).then(function(o){return n._writeFeatures(e,t,r,o,i)})})},t.prototype._writeFeatures=function(e,t,r,n,i){for(var o=i.createMeshData(t.length),s={viewingMode:"",scale:e.scale},c=this._symbolToMosaicItemMap,u=0,p=t;u<p.length;u++){var f=p[u];try{i.write(o,f,r,s,e.level,n,c)}catch(e){l("esri-2d-debug")&&w.error(new a("mapview-mesh-factory","Failed to write feature",{feature:f}))}}return this._encodeDisplayData(o)},t.prototype._encodeDisplayData=function(e){var t={},r=new Array;return e.encode(t,r),{message:t,transferList:r}},t.prototype._handleError=function(e,t,r){var n=r.signal;if(!f.isAbortError(t))return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t.message},{signal:n})},t.prototype._getLabelMosaicItems=function(e,t,r){return s(this,void 0,void 0,function(){var n,i,s,a,l,c;return o(this,function(o){switch(o.label){case 0:return n=u.acquire(),[4,this._createLabelFeatures(e.scale,t,n,r)];case 1:return i=o.sent(),(s=this._symbolToMosaicItemMap,a=u.acquire(),l=[],c=0,n.forEach(function(e,t){if(s.has(t.id)){var r=s.get(t.id),n=r.glyphMosaicItems,i=[];e.forEach(function(e){(n&&n.length<e||!n[e])&&(i[e]=e)}),i.length>0&&(a.set(c,t),l.push({symbol:t.toJSON(),id:c,glyphIds:i}),c++)}else{a.set(c,t);var o=[];e.forEach(function(e){return o.push(e)}),l.push({symbol:t.toJSON(),id:c,glyphIds:o}),c++}}),l.length>0)?[2,this.remoteClient.invoke("tileRenderer.getMaterialItems",l).then(function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t],o=a.get(n.id);if(o)if(_.isTextSymbol(o))if(s.has(o.id)){var l=s.get(o.id),c=l.glyphMosaicItems,p=n.mosaicItem.glyphMosaicItems;if(p)for(var f=0;f<p.length;f++)null!=p[f]&&(c[f]=p[f])}else s.set(o.id,n.mosaicItem);else s.set(o.id,n.mosaicItem)}return u.release(a),i})]:(u.release(n),[2,f.resolve(i)])}})})},t.prototype._getLabelClassInfosForScale=function(e){return s(this,void 0,void 0,function(){var t;return o(this,function(r){switch(r.label){case 0:return[4,this.labelClassInfos];case 1:return t=r.sent(),[2,t.filter(function(t){var r=t.minScale,n=t.maxScale;return(!r||r>=e||0===r)&&(!n||n<=e||0===n)})]}})})},t.prototype._createLabelFeatures=function(e,t,r,n){return s(this,void 0,void 0,function(){var s,a,l,c,f,h,y,g,m,b,_,S,I,O,P,T,C,L,F,E,R,x,U,H,j,N,D,G,J;return o(this,function(o){switch(o.label){case 0:return this.labelingInfo&&t&&0!==t.length?[4,this._getLabelClassInfosForScale(e)]:[2,null];case 1:if(s=o.sent(),0===s.length)return[2,null];for(a=u.acquire(),l=new v.CollisionGrid(v.definitions.COLLISION_EARLY_REJECT_BUCKET_SIZE),c=0,f=t;c<f.length;c++)if(h=f[c],y=this.service.geometryType,g=0,m=0,"esriGeometryPoint"!==y&&"esriGeometryPolygon"!==y||("esriGeometryPoint"===y?(b=h.geometry,g=b.x,m=b.y):(g=h.centroid.x,m=h.centroid.y),!(_=l.checkOverlap(g,m)))){for(S=h.localId,I=new Array,O=0;O<s.length;O++){if(P=s[O],T=P.index,C=P.builder,L=P.symbol,F=h,!n)return w.error("mapview-labeling","Tried to evaluate geometry expression but no transformation found"),[2,void 0];E=n.transform,R=n.hasZ,x=n.hasM,U=this.hydrate(h.geometry,E,R,x),H=i({},h,{geometry:U}),U.spatialReference=d.fromJSON(this.spatialReference),F=H,j=C.evaluate(F),p.isNone(j)||""===j||(v.definitions.DEBUG_LABELS&&(N="-"+S,j=j.substring(0,j.length-N.length)+N),D=v.bidiText(j),G=D[0],J=D[1],M(L,G,r),I.push({text:G,rtl:J,id:T}))}a.set(S,I)}return[2,a]}})})},n([h.property({readOnly:!0})],t.prototype,"supportsTileUpdates",null),n([h.property()],t.prototype,"config",void 0),n([h.property({dependsOn:["config"]})],t.prototype,"labelingInfo",null),n([h.property({dependsOn:["labelingInfo","service","spatialReference"]})],t.prototype,"labelClassInfos",null),n([h.property({dependsOn:["service"]})],t.prototype,"hydrate",null),n([h.property({dependsOn:["config"],readOnly:!0})],t.prototype,"renderer",null),n([h.property({readOnly:!0})],t.prototype,"updating",null),t=n([h.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],t)}(h.declared(I.default));t.default=O});